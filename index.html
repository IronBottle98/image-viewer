<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
  <meta charset="UTF-8" />
  <title>캐릭터챗 외부이미지 미리보기</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Bootstrap -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />

  <!-- LZ-String (URL 압축/해제) -->
  <script src="https://cdn.jsdelivr.net/npm/lz-string@1.4.4/libs/lz-string.min.js"></script>

  <!-- Korean font -->
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700&display=swap" rel="stylesheet" />

  <style>
    body { padding: 20px; font-family: 'Noto Sans KR', sans-serif; }
    .gallery-img { object-fit: contain; height: 100%; width: 100%; border-radius: 0.5rem; transition: transform 0.2s ease, box-shadow 0.2s ease; }
    .gallery-btn { cursor: pointer; }
    .gallery-btn:hover { transform: scale(1.03); box-shadow: 0 8px 20px rgba(0,0,0,0.15); }
    .title-bar { display: flex; flex-wrap: wrap; align-items: center; justify-content: space-between; gap: 0.5rem; padding-bottom: 1rem; }
    .modal-body { user-select: none; }
    .small-mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .failed-textarea { font-size: 12px; line-height: 1.25; }
  </style>
</head>

<body>
  <div class="container">

    <div class="title-bar">
      <h1 class="h4 m-0">캐릭터챗 외부이미지 미리보기</h1>
      <div class="d-flex gap-2">
        <button class="btn btn-outline-info btn-sm" id="copyPageLinkBtn">현재 링크 복사</button>
        <button class="btn btn-outline-secondary btn-sm" id="resetBtn">초기화</button>
      </div>
    </div>

    <!-- Input form -->
    <div id="input-form" class="mb-4">
      <div class="row g-2">
        <div class="col-md">
          <label for="character" class="form-label">
            캐릭터 코드 (쉼표로 구분, 범위: a1..a4 / a..f 가능)
          </label>
          <input id="character" class="form-control" placeholder="">
        </div>
        <div class="col-md">
          <label for="cloth" class="form-label">
            의상 코드 (쉼표로 구분, 범위: 01..12 / a1..a4 / a..f 가능, 빈칸도 가능)
          </label>
          <input id="cloth" class="form-control" placeholder="">
        </div>
        <div class="col-md">
          <label for="situation" class="form-label">
            상황 코드 (쉼표로 구분, 범위: 1..20 / 01..84 가능, 빈칸도 가능)
          </label>
          <input id="situation" class="form-control" placeholder="">
        </div>
      </div>

      <div class="row g-2 mt-2">
        <div class="col-md">
          <label for="template" class="form-label">템플릿 URL (키워드: 캐릭터, 의상, 상황)</label>
          <input id="template" class="form-control" placeholder="">
        </div>
        <div class="col-md-auto d-flex align-items-end">
          <button class="btn btn-primary" id="generate-btn">목록생성</button>
        </div>
      </div>

      <div class="form-text mt-2 text-muted">
        범위 입력 예) a1..a4, 01..12, a..f. 빈칸도 코드로 인식됨(예: 상황에 빈칸을 넣으면 "상황" 치환이 공백).<br>
        이제 프리셋 저장은 URL에 자동 저장됨 → PC/모바일에서 같은 링크를 열면 동일하게 복원됨.
      </div>
    </div>

    <!-- Gallery container -->
    <div class="row" id="gallery-container"></div>

    <!-- 하단: 출력되지 않은 이미지 목록(접기/펼치기) -->
    <div id="failed-items-panel" class="card border-secondary text-muted rounded mt-3" style="display:none;">
      <div class="card-header p-2">
        <h6 class="mb-0">
          <a class="text-muted text-decoration-none d-flex align-items-center"
             data-bs-toggle="collapse"
             href="#failed-items-collapse"
             role="button"
             aria-expanded="true"
             aria-controls="failed-items-collapse">
            출력되지 않은 이미지 목록
            <span class="ms-auto small">(접기/펼치기)</span>
          </a>
        </h6>
      </div>
      <div id="failed-items-collapse" class="collapse show">
        <div class="card-body p-2">
          <textarea id="failed-items-text"
                    class="form-control failed-textarea"
                    rows="10"
                    readonly
                    spellcheck="false"></textarea>
        </div>
      </div>
    </div>

  </div>

  <!-- Image Modal -->
  <div class="modal fade" id="imageModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl">
      <div class="modal-content">
        <div class="modal-header border-0 pt-2 pb-0">
          <h6 class="modal-title small-mono" id="modalTitle">Image</h6>

          <button type="button"
                  class="btn p-1 m-1 d-flex align-items-center justify-content-center"
                  data-bs-toggle="tooltip" data-bs-placement="bottom"
                  id="copyUrl" title="복사">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-copy" viewBox="0 0 16 16">
              <path fill-rule="evenodd" d="M4 2a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2zm2-1a1 1 0 0 0-1 1v8a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1zM2 5a1 1 0 0 0-1 1v8a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1v-1h1v1a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h1v1z"/>
            </svg>
          </button>

          <button type="button" class="btn-close btn-close-white ms-auto" data-bs-dismiss="modal"></button>
        </div>

        <div class="modal-body d-flex justify-content-center align-items-center position-relative">
          <button class="btn btn-dark position-absolute start-0 translate-middle-y d-flex p-2 align-items-center justify-content-center"
                  style="top:50%; margin-left:-10px;"
                  id="prevImage">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-chevron-left" viewBox="0 0 16 16">
              <path fill-rule="evenodd" d="M11.354 1.646a.5.5 0 0 1 0 .708L5.707 8l5.647 5.646a.5.5 0 0 1-.708.708l-6-6a.5.5 0 0 1 0-.708l6-6a.5.5 0 0 1 .708 0"/>
            </svg>
          </button>

          <img id="modalImage" src="" alt="Full View" class="img-fluid rounded">

          <button class="btn btn-dark position-absolute end-0 translate-middle-y d-flex p-2 align-items-center justify-content-center"
                  style="top:50%; margin-right:-10px;"
                  id="nextImage">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-chevron-right" viewBox="0 0 16 16">
              <path fill-rule="evenodd" d="M4.646 1.646a.5.5 0 0 1 .708 0l6 6a.5.5 0 0 1 0 .708l-6 6a.5.5 0 0 1-.708-.708L10.293 8 4.646 2.354a.5.5 0 0 1 0-.708"/>
            </svg>
          </button>
        </div>
      </div>
    </div>
  </div>

  <footer class="py-3 mt-auto">
    <hr />
    <div class="container text-center text-muted">
      <small>
        사이트 개발: 시란 (새벽제작) | <a href="https://arca.live/b/dawncraft/149404969" target="_blank" rel="noreferrer">이용 가이드</a>
      </small>
    </div>
  </footer>

  <script>
    // =========================
    // Toast (Bootstrap)
    // =========================
    function toast(message) {
      const wrapper = document.createElement("div");
      wrapper.className = "toast align-items-center text-bg-dark border-0 position-fixed bottom-0 end-0 m-3";
      wrapper.setAttribute("role", "alert");
      wrapper.setAttribute("aria-live", "assertive");
      wrapper.setAttribute("aria-atomic", "true");
      wrapper.innerHTML = `
        <div class="d-flex">
          <div class="toast-body">${message}</div>
          <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
      `;
      document.body.appendChild(wrapper);
      const t = new bootstrap.Toast(wrapper, { delay: 1500 });
      t.show();
      wrapper.addEventListener("hidden.bs.toast", () => wrapper.remove());
    }

    // =========================
    // URL 압축 상태 (B안)
    // =========================
    function encodeStateToP(state) {
      // state: {t,c,l,s,d}
      const json = JSON.stringify(state);
      return LZString.compressToEncodedURIComponent(json);
    }

    function decodeStateFromP(p) {
      try {
        const json = LZString.decompressFromEncodedURIComponent(p);
        if (!json) return null;
        const obj = JSON.parse(json);
        if (!obj || typeof obj !== "object") return null;
        return obj;
      } catch {
        return null;
      }
    }

    function readStateFromUrl() {
      const url =C = new URL(window.location.href);
      const sp = urlC.searchParams;

      // 1) 새 방식: p=
      const p = sp.get("p");
      if (p) {
        const obj = decodeStateFromP(p);
        if (obj) return normalizeState(obj);
      }

      // 2) 구버전 호환: t,c,l,s,d
      const legacy = {
        t: sp.get("t") ?? sp.get("template") ?? "",
        c: sp.get("c") ?? sp.get("character") ?? "",
        l: sp.get("l") ?? sp.get("cloth") ?? "",
        s: sp.get("s") ?? sp.get("situation") ?? "",
        d: sp.get("d") ?? sp.get("detail") ?? ""
      };
      // legacy는 , 대신 ~ 쓰던 구조가 있을 수 있어서 그대로 유지
      return normalizeState(legacy);
    }

    function normalizeState(obj) {
      return {
        t: (obj.t ?? "").toString(),
        c: (obj.c ?? "").toString(),
        l: (obj.l ?? "").toString(),
        s: (obj.s ?? "").toString(),
        d: (obj.d ?? "").toString(),
      };
    }

    function writeStateToUrl(state, { replace = false } = {}) {
      const url = new URL(window.location.href);
      const p = encodeStateToP(normalizeState(state));
      url.search = new URLSearchParams({ p }).toString();

      if (replace) history.replaceState(null, "", url.toString());
      else history.pushState(null, "", url.toString());
    }

    // =========================
    // Form helpers
    // =========================
    function setFormValuesFromState(st) {
      // 입력폼은 사용자 친화적으로 "," 기반을 기본으로 유지
      // URL에는 어떤 문자가 들어가든 p로 압축되므로 안전
      document.getElementById("template").value = st.t ?? "";
      document.getElementById("character").value = (st.c ?? "").replaceAll("~", ",");
      document.getElementById("cloth").value = (st.l ?? "").replaceAll("~", ",");
      document.getElementById("situation").value = (st.s ?? "").replaceAll("~", ",");
    }

    function getStateFromForm(detailValue = "") {
      // 빈칸 토큰 유지 위해 "," -> "~" 로만 변환해서 저장 (a,,b => a~~b)
      const t = document.getElementById("template").value.trim();
      const c = document.getElementById("character").value.replaceAll(",", "~");
      const l = document.getElementById("cloth").value.replaceAll(",", "~");
      const s = document.getElementById("situation").value.replaceAll(",", "~");
      return normalizeState({ t, c, l, s, d: detailValue });
    }

    function setDefaultIfEmpty(st) {
      const emptyAll = !st.t && !st.c && !st.l && !st.s;
      if (!emptyAll) return st;

      return normalizeState({
        t: "https://si-ran.com/gg/캐릭터-의상-상황.webp",
        c: "a~b~c~d~e~f~i",
        l: "1~2",
        s: "1~3..11",
        d: ""
      });
    }

    // =========================
    // (가능하면) 404 요청 자체를 줄이는 존재 확인
    // =========================
    async function probeImage(url) {
      try {
        const resp = await fetch(url, { method: "HEAD", cache: "no-store" });
        return resp.ok;
      } catch {
        return null; // CORS/네트워크로 확인불가
      }
    }

    // =========================
    // Range expansion for ALL codes (캐릭터/의상/상황)
    // =========================
    function expandRangeToken(token) {
      if (token === "") return [""]; // 빈칸도 유효

      if (!token.includes("..")) return [token];

      const parts = token.split("..");
      if (parts.length !== 2) return [token];

      const leftRaw = parts[0].trim();
      const rightRaw = parts[1].trim();
      if (leftRaw === "" || rightRaw === "") return [token];

      // numeric..numeric (패딩 유지)
      if (/^\d+$/.test(leftRaw) && /^\d+$/.test(rightRaw)) {
        const len = leftRaw.length;
        const start = Number(leftRaw);
        const end = Number(rightRaw);
        if (!Number.isFinite(start) || !Number.isFinite(end) || start > end) return [token];
        const out = [];
        for (let i = start; i <= end; i++) out.push(String(i).padStart(len, "0"));
        return out;
      }

      // single letter..single letter
      if (/^[A-Za-z]$/.test(leftRaw) && /^[A-Za-z]$/.test(rightRaw)) {
        const a = leftRaw.charCodeAt(0);
        const b = rightRaw.charCodeAt(0);
        if (a > b) return [token];
        const out = [];
        for (let c = a; c <= b; c++) out.push(String.fromCharCode(c));
        return out;
      }

      // prefix+digits .. prefix+digits (same prefix, padding 유지)
      const m1 = leftRaw.match(/^(.+?)(\d+)$/);
      const m2 = rightRaw.match(/^(.+?)(\d+)$/);
      if (m1 && m2) {
        const p1 = m1[1], n1 = m1[2];
        const p2 = m2[1], n2 = m2[2];
        if (p1 !== p2) return [token];

        const len = n1.length;
        const start = Number(n1);
        const end = Number(n2);
        if (!Number.isFinite(start) || !Number.isFinite(end) || start > end) return [token];

        const out = [];
        for (let i = start; i <= end; i++) out.push(p1 + String(i).padStart(len, "0"));
        return out;
      }

      return [token];
    }

    function expandCodesFromParam(paramWithTilde) {
      if (paramWithTilde == null) return null;
      const rawTokens = paramWithTilde.split("~").map(s => s.trim()); // a~~b => ["a","","b"]
      const expanded = [];
      for (const t of rawTokens) {
        const chunks = expandRangeToken(t);
        for (const c of chunks) expanded.push(c);
      }
      return expanded;
    }

    // =========================
    // Failed list UI helpers
    // =========================
    const container = document.getElementById("gallery-container");
    const failedPanel = document.getElementById("failed-items-panel");
    const failedText = document.getElementById("failed-items-text");

    let failedUrls = new Set();
    function addFailed(url) {
      if (!url) return;
      failedUrls.add(url);
      renderFailed();
    }
    function renderFailed() {
      const arr = Array.from(failedUrls);
      if (arr.length === 0) {
        failedPanel.style.display = "none";
        failedText.value = "";
        return;
      }
      failedPanel.style.display = "block";
      failedText.value = arr.join("\n");
    }

    // =========================
    // Concurrency limit for async tasks
    // =========================
    async function asyncPool(limit, array, iteratorFn) {
      const ret = [];
      const executing = [];
      for (const item of array) {
        const p = Promise.resolve().then(() => iteratorFn(item));
        ret.push(p);

        if (limit <= array.length) {
          const e = p.then(() => executing.splice(executing.indexOf(e), 1));
          executing.push(e);
          if (executing.length >= limit) await Promise.race(executing);
        }
      }
      return Promise.all(ret);
    }

    // =========================
    // Rendering
    // =========================
    let currentState = null;

    function buildUrlFromParts(template, char, clo, sit) {
      return template
        .replace("캐릭터", char ?? "")
        .replace("의상", clo ?? "")
        .replace("상황", sit ?? "");
    }

    function clearView() {
      container.innerHTML = "";
      failedUrls = new Set();
      renderFailed();
    }

    async function renderFromState(st, { writeUrl = true, replaceUrl = false } = {}) {
      st = setDefaultIfEmpty(normalizeState(st));
      currentState = st;

      // URL 반영 (항상 p=만 쓰는 B안)
      if (writeUrl) writeStateToUrl(st, { replace: replaceUrl });

      // 폼 반영
      setFormValuesFromState(st);

      // 뷰 초기화
      clearView();

      // 필수 확인
      if (!st.t || !st.c || !st.s) return;

      const characters = expandCodesFromParam(st.c);
      const clothes = expandCodesFromParam(st.l ?? "") ?? [""];
      const situations = expandCodesFromParam(st.s);

      if (!characters || characters.length === 0 || !situations || situations.length === 0) return;

      // 디테일 파라미터 없으면: 조합 목록(미리보기)
      if (!st.d) {
        const previewSituation = situations[0] ?? "";

        characters.forEach((char, ci) => {
          clothes.forEach((clo, cli) => {
            const imgUrl = buildUrlFromParts(st.t, char, clo, previewSituation);
            const comboId = `${ci}-${cli}`;

            const col = document.createElement("div");
            col.className = "col-md-4 mb-4";

            const img = document.createElement("img");
            img.className = "gallery-img gallery-btn";
            img.alt = `${char}-${clo}`;
            img.src = imgUrl;

            // 깨진 타일 보이기 싫으면 여기에도 error 처리
            img.addEventListener("error", () => {
              // 조합 썸네일이 깨져도 조합 진입은 필요할 수 있어서
              // 타일 삭제 대신, 실패 목록에만 넣고 숨김 처리
              col.remove();
              addFailed(imgUrl);
            });

            img.addEventListener("click", () => {
              const next = { ...st, d: comboId };
              renderFromState(next, { writeUrl: true, replaceUrl: false });
              window.scrollTo({ top: 0, behavior: "instant" });
            });

            col.appendChild(img);
            container.appendChild(col);
          });
        });

        return;
      }

      // 디테일 모드
      const match = st.d.match(/(\d+)-(\d+)/);
      if (!match) return;

      const charIndex = parseInt(match[1], 10);
      const clothIndex = parseInt(match[2], 10);

      const validSituations = new Set();

      function buildMatchImageUrl(sit) {
        return buildUrlFromParts(st.t, characters[charIndex], clothes[clothIndex], sit);
      }

      function createImageCard(imgUrl, sit, si) {
        const card = document.createElement("div");
        card.className = "col-md-4 mb-4";
        card.style.display = "none";

        const img = document.createElement("img");
        img.className = "gallery-img gallery-btn";
        img.alt = (sit === "" ? "(blank)" : sit);

        img.addEventListener("load", () => {
          if (!card.isConnected) return;
          card.style.display = "block";
          validSituations.add(sit);
        });

        img.addEventListener("error", () => {
          card.remove();
          validSituations.delete(sit);
          addFailed(imgUrl);
        });

        img.addEventListener("click", () => showImageModal(si));

        img.src = imgUrl;
        card.appendChild(img);
        container.appendChild(card);
      }

      // 먼저 HEAD로 확인 가능한 건 걸러서 404 요청 자체를 줄임
      await asyncPool(12, situations.map((sit, si) => ({ sit, si })), async ({ sit, si }) => {
        const imgUrl = buildMatchImageUrl(sit);
        const ok = await probeImage(imgUrl);

        if (ok === false) {
          addFailed(imgUrl);
          return;
        }
        createImageCard(imgUrl, sit, si);
      });

      // ===== Modal logic =====
      const copyButton = document.getElementById("copyUrl");
      const copyTooltip = new bootstrap.Tooltip(copyButton, { title: "복사됨!", trigger: "manual" });

      const prevButton = document.getElementById("prevImage");
      const nextButton = document.getElementById("nextImage");

      let modalIndex = 0;

      function getPrevValidIndex(currentIndex) {
        for (let i = currentIndex - 1; i >= 0; --i) {
          if (validSituations.has(situations[i])) return i;
        }
        return -1;
      }

      function getNextValidIndex(currentIndex) {
        for (let i = currentIndex + 1; i < situations.length; ++i) {
          if (validSituations.has(situations[i])) return i;
        }
        return -1;
      }

      function updateImageModal(situationIndex) {
        if (situationIndex < 0) return;

        const imageUrl = buildMatchImageUrl(situations[situationIndex]);
        if (!imageUrl) return;

        modalIndex = situationIndex;
        prevButton.style.visibility = getPrevValidIndex(modalIndex) < 0 ? "hidden" : "visible";
        nextButton.style.visibility = getNextValidIndex(modalIndex) < 0 ? "hidden" : "visible";

        document.getElementById("modalTitle").innerHTML = imageUrl;
        document.getElementById("modalImage").src = imageUrl;
      }

      function showImageModal(situationIndex) {
        if (!validSituations.has(situations[situationIndex])) return;

        updateImageModal(situationIndex);
        const modal = new bootstrap.Modal(document.getElementById("imageModal"));
        modal.show();
      }

      // 이벤트 중복 방지: 한 번만 바인딩
      copyButton.onclick = () => {
        const titleText = document.getElementById("modalTitle").innerText;
        navigator.clipboard.writeText(titleText).then(() => {
          copyTooltip.show();
          setTimeout(() => copyTooltip.hide(), 1000);
        });
      };

      prevButton.onclick = () => updateImageModal(getPrevValidIndex(modalIndex));
      nextButton.onclick = () => updateImageModal(getNextValidIndex(modalIndex));

      // 전역에서 접근 가능하도록
      window.showImageModal = showImageModal;
    }

    // =========================
    // UI events
    // =========================
    document.getElementById("generate-btn").addEventListener("click", () => {
      const st = getStateFromForm("");
      renderFromState(st, { writeUrl: true, replaceUrl: false });
      window.scrollTo({ top: 0, behavior: "instant" });
    });

    document.getElementById("copyPageLinkBtn").addEventListener("click", async () => {
      try {
        await navigator.clipboard.writeText(window.location.href);
        toast("현재 링크 복사됨");
      } catch {
        // fallback
        prompt("복사 실패. 아래 링크를 직접 복사해줘.", window.location.href);
      }
    });

    document.getElementById("resetBtn").addEventListener("click", () => {
      const st = normalizeState({ t:"", c:"", l:"", s:"", d:"" });
      renderFromState(st, { writeUrl: true, replaceUrl: true });
    });

    // 뒤로가기/앞으로가기 대응
    window.addEventListener("popstate", () => {
      const st = readStateFromUrl();
      renderFromState(st, { writeUrl: false });
    });

    // =========================
    // Boot
    // =========================
    (function boot() {
      const st = setDefaultIfEmpty(readStateFromUrl());
      renderFromState(st, { writeUrl: true, replaceUrl: true });
    })();
  </script>
</body>
</html>
