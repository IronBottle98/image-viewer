<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
  <meta charset="UTF-8" />
  <title>캐릭터챗 외부이미지 미리보기</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Bootstrap -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />

  <!-- Korean font -->
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700&display=swap" rel="stylesheet" />

  <style>
    body { padding: 20px; font-family: 'Noto Sans KR', sans-serif; }
    .gallery-img { object-fit: contain; height: 100%; width: 100%; border-radius: 0.5rem; transition: transform 0.2s ease, box-shadow 0.2s ease; }
    .gallery-btn { cursor: pointer; }
    .gallery-btn:hover { transform: scale(1.03); box-shadow: 0 8px 20px rgba(0,0,0,0.15); }
    .title-bar { display: flex; flex-wrap: wrap; align-items: center; justify-content: space-between; gap: 0.5rem; padding-bottom: 1rem; }
    .modal-body { user-select: none; }
    .small-mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    pre { margin: 0; }
  </style>
</head>

<body>
  <div class="container">

    <div class="title-bar">
      <h1 class="h4 m-0">캐릭터챗 외부이미지 미리보기</h1>

      <!-- ✅ 버튼 1번: urls.txt + download.ps1 자동 다운로드 -->
      <div class="d-flex gap-2 ms-auto">
        <button class="btn btn-outline-success btn-sm" id="exportPackBtn" title="urls.txt와 download.ps1을 자동으로 내려받습니다">
          PowerShell 패키지 내보내기
        </button>
      </div>
    </div>

    <!-- Input form -->
    <div id="input-form" class="mb-4">
      <div class="row g-2">
        <div class="col-md">
          <label for="character" class="form-label">
            캐릭터 코드 (쉼표로 구분, 범위: a1..a4 / a..f 가능)
          </label>
          <input id="character" class="form-control" placeholder="">
        </div>
        <div class="col-md">
          <label for="cloth" class="form-label">
            의상 코드 (쉼표로 구분, 범위: 01..12 / a1..a4 / a..f 가능, 없으면 빈칸도 가능)
          </label>
          <input id="cloth" class="form-control" placeholder="">
        </div>
        <div class="col-md">
          <label for="situation" class="form-label">
            상황 코드 (쉼표로 구분, 범위: 1..20 / 01..84 가능, 빈칸도 가능)
          </label>
          <input id="situation" class="form-control" placeholder="">
        </div>
      </div>

      <div class="row g-2 mt-2">
        <div class="col-md">
          <label for="template" class="form-label">템플릿 URL (키워드: 캐릭터, 의상, 상황)</label>
          <input id="template" class="form-control" placeholder="">
        </div>
        <div class="col-md-auto d-flex align-items-end">
          <button class="btn btn-primary" id="generate-btn">목록생성</button>
        </div>
      </div>

      <div class="form-text mt-2 text-muted">
        범위 입력 예) a1..a4, 01..12, a..f. 빈칸도 코드로 인식됨(예: 상황에 빈칸을 넣으면 "상황" 치환이 공백).
      </div>

      <div class="alert alert-secondary py-2 mt-3 mb-0 small">
        <div class="mb-1">✅ <b>PowerShell 패키지 내보내기</b> 버튼을 누르면 <code>urls_날짜.txt</code> + <code>download.ps1</code> 두 파일을 자동 다운로드.</div>
        <div class="mb-2">✅ 두 파일이 같은 폴더(보통 다운로드 폴더)에 있으면, PowerShell에서 아래 <b>1줄</b>만 실행하면 끝.</div>
        <div class="bg-dark text-light rounded p-2">
          <code>powershell -ExecutionPolicy Bypass -File .\download.ps1 -UrlListPath .\urls_*.txt -OutDir .\imgs</code>
        </div>
      </div>
    </div>

    <!-- Gallery container -->
    <div class="row" id="gallery-container"></div>

  </div>

  <script>
    // =========================
    // Query / Navigation helpers
    // =========================
    function getQueryParam(name) {
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get(name)?.replaceAll(',', '~');
    }

    function redirectWithParams(params) {
      const url = new URL(window.location.href);
      url.search = new URLSearchParams(params).toString();
      window.location.href = url.toString();
    }

    function setFormValues(template, character, cloth, situation) {
      if (template == null && character == null && situation == null && cloth == null) {
        template = 'https://si-ran.com/gg/캐릭터-의상-상황.webp';
        character = 'a,b,c,d,e,f,i';
        cloth = '1,2';
        situation = '1,3..11';
      } else {
        character = character?.replaceAll('~', ',');
        cloth = cloth?.replaceAll('~', ',');
        situation = situation?.replaceAll('~', ',');
      }

      document.getElementById('template').value = template ?? '';
      document.getElementById('character').value = character ?? '';
      document.getElementById('cloth').value = cloth ?? '';
      document.getElementById('situation').value = situation ?? '';
    }

    async function checkImageExists(url) {
      try {
        const response = await fetch(url, { method: 'HEAD' });
        return response.ok;
      } catch (error) {
        // CORS 등으로 실패할 수 있으니 "있다고 가정"
        return true;
      }
    }

    // =========================
    // Range expansion
    // =========================
    function expandRangeToken(token) {
      if (token === '') return [''];
      if (!token.includes('..')) return [token];

      const parts = token.split('..');
      if (parts.length !== 2) return [token];

      const leftRaw = parts[0].trim();
      const rightRaw = parts[1].trim();
      if (leftRaw === '' || rightRaw === '') return [token];

      if (/^\d+$/.test(leftRaw) && /^\d+$/.test(rightRaw)) {
        const len = leftRaw.length;
        const start = Number(leftRaw);
        const end = Number(rightRaw);
        if (!Number.isFinite(start) || !Number.isFinite(end) || start > end) return [token];
        const out = [];
        for (let i = start; i <= end; i++) out.push(String(i).padStart(len, '0'));
        return out;
      }

      if (/^[A-Za-z]$/.test(leftRaw) && /^[A-Za-z]$/.test(rightRaw)) {
        const a = leftRaw.charCodeAt(0);
        const b = rightRaw.charCodeAt(0);
        if (a > b) return [token];
        const out = [];
        for (let c = a; c <= b; c++) out.push(String.fromCharCode(c));
        return out;
      }

      const m1 = leftRaw.match(/^(.+?)(\d+)$/);
      const m2 = rightRaw.match(/^(.+?)(\d+)$/);
      if (m1 && m2) {
        const p1 = m1[1], n1 = m1[2];
        const p2 = m2[1], n2 = m2[2];
        if (p1 !== p2) return [token];

        const len = n1.length;
        const start = Number(n1);
        const end = Number(n2);
        if (!Number.isFinite(start) || !Number.isFinite(end) || start > end) return [token];

        const out = [];
        for (let i = start; i <= end; i++) out.push(p1 + String(i).padStart(len, '0'));
        return out;
      }

      return [token];
    }

    function expandCodesFromParam(paramWithTilde) {
      if (paramWithTilde == null) return null;
      const rawTokens = paramWithTilde.split('~').map(s => s.trim());

      const expanded = [];
      for (const t of rawTokens) {
        const chunks = expandRangeToken(t);
        for (const c of chunks) expanded.push(c);
      }
      return expanded;
    }

    // =========================
    // ✅ PowerShell 패키지 내보내기 (버튼 1번)
    // - urls_*.txt + download.ps1 동시 다운로드
    // =========================
    function getVisibleGalleryUrls() {
      const imgs = Array.from(document.querySelectorAll("#gallery-container img"));
      const urls = imgs
        .filter(img => img && img.src)
        .filter(img => {
          const card = img.closest(".col-md-4");
          if (!card) return true;
          return card.style.display !== "none";
        })
        .map(img => img.src);

      const seen = new Set();
      const uniq = [];
      for (const u of urls) {
        if (!seen.has(u)) { seen.add(u); uniq.push(u); }
      }
      return uniq;
    }

    function downloadTextFile(filename, text) {
      const blob = new Blob([text], { type: "text/plain;charset=utf-8" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    function ps1ScriptContent() {
      // NOTE: 여기 문자열 그대로 download.ps1로 저장됨
      return String.raw`param(
  [string]$UrlListPath = ".\urls.txt",
  [string]$OutDir = ".\imgs"
)

# 출력 폴더 생성
New-Item -ItemType Directory -Force -Path $OutDir | Out-Null

# TLS 설정(일부 환경에서 필요)
try {
  [Net.ServicePointManager]::SecurityProtocol = `
    [Net.SecurityProtocolType]::Tls12 -bor [Net.SecurityProtocolType]::Tls13
} catch {}

# URL 목록 읽기 (빈 줄 제거 + 중복 제거)
$urls = Get-Content $UrlListPath | Where-Object { $_ -and $_.Trim() -ne "" } | Select-Object -Unique
if ($null -eq $urls -or $urls.Count -eq 0) {
  Write-Host "URL이 없습니다: $UrlListPath"
  exit 1
}

function Get-SafeFileName([string]$name) {
  if ([string]::IsNullOrWhiteSpace($name)) { return "" }
  return ($name -replace '[\\/:*?"<>|]', "_").Trim()
}

function Guess-Ext-FromUrl([string]$url) {
  try {
    $clean = $url.Split('#')[0].Split('?')[0]
    $m = [regex]::Match($clean, '\.([a-zA-Z0-9]{2,5})$')
    if ($m.Success) { return $m.Groups[1].Value.ToLower() }
  } catch {}
  return "webp"
}

$index = 0
foreach ($u in $urls) {
  $index++

  try {
    $uri = [Uri]$u
    $name = [IO.Path]::GetFileName($uri.AbsolutePath)

    # URL 끝에 파일명이 없거나 확장자 없으면 순번 파일명 부여
    if ([string]::IsNullOrWhiteSpace($name) -or -not ($name -match '\.')) {
      $ext = Guess-Ext-FromUrl $u
      $name = ("image_{0:0000}.{1}" -f $index, $ext)
    }

    $safeName = Get-SafeFileName $name
    if ([string]::IsNullOrWhiteSpace($safeName)) {
      $safeName = ("image_{0:0000}.{1}" -f $index, (Guess-Ext-FromUrl $u))
    }

    $outPath = Join-Path $OutDir $safeName
    Write-Host ("[{0}/{1}] 다운로드: {2} -> {3}" -f $index, $urls.Count, $u, $safeName)

    # 헤더가 필요한 서버가 있으면 여기서 추가 가능:
    # $headers = @{ "User-Agent" = "Mozilla/5.0" }
    # Invoke-WebRequest -Uri $u -OutFile $outPath -Headers $headers -TimeoutSec 60

    Invoke-WebRequest -Uri $u -OutFile $outPath -UseBasicParsing -TimeoutSec 60
  }
  catch {
    Write-Warning "실패: $u"
    Write-Warning $_.Exception.Message
  }
}

Write-Host "완료: $OutDir"
`;
    }

    document.getElementById("exportPackBtn")?.addEventListener("click", () => {
      const urls = getVisibleGalleryUrls();
      if (urls.length === 0) {
        alert("내보낼 이미지 URL이 없음(목록생성 후 상세 화면에서 시도해줘)");
        return;
      }

      const stamp = new Date().toISOString().replace(/[:.]/g, "-");
      const urlFile = `urls_${stamp}.txt`;

      // 1) urls txt 다운로드
      downloadTextFile(urlFile, urls.join("\n"));

      // 2) download.ps1 다운로드
      downloadTextFile("download.ps1", ps1ScriptContent());

      alert(
        `다운로드됨:\n- ${urlFile}\n- download.ps1\n\n` +
        `두 파일이 같은 폴더에 있을 때 PowerShell에서 아래 1줄 실행:\n` +
        `powershell -ExecutionPolicy Bypass -File .\\download.ps1 -UrlListPath .\\${urlFile} -OutDir .\\imgs`
      );
    });

    // =========================
    // Form submission (querystring)
    // =========================
    document.getElementById('generate-btn')?.addEventListener('click', () => {
      const template = document.getElementById('template').value.trim();
      const character = document.getElementById('character').value.replaceAll(',', '~');
      const cloth = document.getElementById('cloth').value.replaceAll(',', '~');
      const situation = document.getElementById('situation').value.replaceAll(',', '~');
      redirectWithParams({ t: template, c: character, l: cloth, s: situation });
    });

    // =========================
    // Gallery generation
    // =========================
    const templateParam = getQueryParam('t') ?? getQueryParam('template');
    const characterParam = getQueryParam('c') ?? getQueryParam('character');
    const clothParam = getQueryParam('l') ?? getQueryParam('cloth');
    const situationParam = getQueryParam('s') ?? getQueryParam('situation');
    const detailParam = getQueryParam('d') ?? getQueryParam('detail');
    const container = document.getElementById('gallery-container');

    setFormValues(templateParam, characterParam, clothParam, situationParam);

    const hasRequired =
      templateParam != null &&
      characterParam != null &&
      situationParam != null &&
      clothParam != null;

    if (hasRequired && templateParam !== '' && characterParam !== '' && situationParam !== '') {
      const characters = expandCodesFromParam(characterParam);
      const clothes = expandCodesFromParam(clothParam) ?? [''];
      const situations = expandCodesFromParam(situationParam);

      if (!characters || !situations || characters.length === 0 || situations.length === 0) {
        // do nothing
      } else if (!detailParam) {
        characters.forEach((char, ci) => {
          clothes.forEach((clo, cli) => {
            const previewSituation = situations[0] ?? '';
            const imgUrl = templateParam
              .replace('캐릭터', char ?? '')
              .replace('의상', clo ?? '')
              .replace('상황', previewSituation ?? '');

            const comboId = `${ci}-${cli}`;

            const col = document.createElement('div');
            col.className = 'col-md-4 mb-4';
            col.innerHTML = `
              <img src="${imgUrl}" alt="${(char ?? '')}-${(clo ?? '')}" class="gallery-img gallery-btn" onclick="redirectWithParams({
                t: '${templateParam}',
                c: '${characterParam}',
                l: '${clothParam}',
                s: '${situationParam}',
                d: '${comboId}',
              })">
            `;
            container.appendChild(col);
          });
        });
      } else {
        function buildMatchImageUrl(situation) {
          const match = detailParam.match(/(\d+)-(\d+)/);
          if (!match) return null;

          const charIndex = parseInt(match[1]);
          const clothIndex = parseInt(match[2]);

          return templateParam
            .replace('캐릭터', characters[charIndex] ?? '')
            .replace('의상', clothes[clothIndex] ?? '')
            .replace('상황', situation ?? '');
        }

        situations.forEach(async (sit, si) => {
          const imgUrl = buildMatchImageUrl(sit);
          if (!imgUrl) return;

          const card = document.createElement('div');
          card.className = 'col-md-4 mb-4';
          card.style.display = 'none';

          const img = document.createElement('img');

          img.addEventListener('load', function () {
            if (card.isConnected) {
              card.style.display = 'block';
            }
          });

          img.addEventListener('error', function () {
            card.remove();
          });

          img.src = imgUrl;
          img.alt = (sit === '' ? '(blank)' : sit);
          img.className = 'gallery-img gallery-btn';

          card.appendChild(img);
          container.appendChild(card);

          if (!await checkImageExists(imgUrl)) {
            card.remove();
          }
        });
      }
    }
  </script>
</body>
</html>
